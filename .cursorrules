# SplitWiser - Cursor AI Rules

## Project Context

You are working on **SplitWiser**, a Next.js expense tracking and splitting application. This is a **proof-of-concept** (POC) with intentional simplifications.

**IMPORTANT**: Always read `ARCHITECTURE.md` first for comprehensive project understanding.

---

## üîÑ Documentation Maintenance (REQUIRED)

**After completing ANY feature, bug fix, or significant change, ALWAYS consider updating documentation:**

### Checklist (ask yourself these questions):

1. **README.md** - Does the feature list, setup instructions, or project description need updating?
2. **ARCHITECTURE.md** - Did I add new:
   - Directories or files that should be documented?
   - Data flows or patterns?
   - Database tables or relationships?
   - Services, repositories, or hooks?
3. **.cursorrules** (this file) - Should I update:
   - Code conventions or patterns?
   - POC limitations list?
   - Quick reference table?
   - Common tasks section?
4. **Type definitions** - Are new types documented with JSDoc comments?

### When to Update:

| Change Type | Update Required |
|-------------|-----------------|
| New page/route | README (features), ARCHITECTURE (directory structure) |
| New component pattern | .cursorrules (component patterns) |
| New service/repository | ARCHITECTURE (layers diagram, data flows) |
| Database schema change | ARCHITECTURE (schema section), supabase/schema.sql |
| New environment variable | README, ARCHITECTURE, env.example |
| Bug fix with learnings | .cursorrules (add to relevant section) |
| POC limitation removed | .cursorrules (update POC limitations) |
| New dependency | README (tech stack if major) |

### How to Propose Updates:

At the end of a feature implementation, say:
> "Feature complete. Based on the changes, I recommend updating [specific docs] with [specific changes]. Should I proceed?"

**Keep documentation in sync with code. Outdated docs are worse than no docs.**

---

## Tech Stack

- **Framework**: Next.js 16 with App Router, React 19
- **Database**: Supabase (PostgreSQL)
- **State**: TanStack Query v5
- **UI**: shadcn/ui + Radix UI + Tailwind CSS v4
- **Forms**: react-hook-form + Zod
- **Package Manager**: pnpm

## Key Conventions

### File Organization

```
src/
‚îú‚îÄ‚îÄ app/           ‚Üí Pages (App Router)
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/        ‚Üí shadcn primitives (DON'T EDIT DIRECTLY)
‚îÇ   ‚îú‚îÄ‚îÄ common/    ‚Üí Reusable business components
‚îÇ   ‚îú‚îÄ‚îÄ features/  ‚Üí Feature-specific components
‚îÇ   ‚îî‚îÄ‚îÄ layout/    ‚Üí App shell, navigation
‚îú‚îÄ‚îÄ hooks/queries/ ‚Üí TanStack Query hooks
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ services/  ‚Üí Business logic
‚îÇ   ‚îú‚îÄ‚îÄ repositories/ ‚Üí Data access (Supabase)
‚îÇ   ‚îî‚îÄ‚îÄ types/     ‚Üí TypeScript definitions
‚îî‚îÄ‚îÄ providers/     ‚Üí Context providers
```

### Architecture Pattern

**Always follow the layer pattern:**
```
Page ‚Üí Component ‚Üí Hook ‚Üí Service ‚Üí Repository ‚Üí Supabase
```

**Never skip layers** (e.g., don't call repository directly from component).

### Imports

Use path aliases:
```typescript
import { Button } from '@/components/ui/button';
import { expenseService } from '@/lib/services';
import { useCreateExpense } from '@/hooks/queries';
import { cn } from '@/lib/utils';
```

### Component Patterns

1. **Client components** must have `'use client'` directive
2. **Always handle loading states** with `<LoadingSkeleton />`
3. **Always handle empty states** with `<EmptyState />`
4. **Use `cn()` for conditional classes**

```typescript
'use client';

import { cn } from '@/lib/utils';

export function MyComponent({ variant }: Props) {
  const { data, isLoading } = useMyQuery();
  
  if (isLoading) return <LoadingSkeleton />;
  if (!data?.length) return <EmptyState />;
  
  return (
    <div className={cn(
      "base-class",
      variant === "active" && "active-class"
    )}>
      {/* content */}
    </div>
  );
}
```

### Type Conventions

1. **Domain types** use camelCase: `categoryId`, `groupId`
2. **Database row types** use snake_case: `category_id`, `group_id`
3. **Always use transform functions**: `expenseFromRow(row)`

```typescript
// Domain type
interface Expense {
  categoryId: string;
  date: Date;
}

// Database row
interface ExpenseRow {
  category_id: string;
  date: string; // ISO string
}

// Transform (always provided in types file)
const expense = expenseFromRow(row);
```

### Query Keys

Always use centralized query keys from `src/hooks/queries/query-keys.ts`:

```typescript
import { queryKeys } from './query-keys';

// ‚úÖ Correct
queryKey: queryKeys.expenses.personal(userId)

// ‚ùå Wrong
queryKey: ['expenses', 'personal', userId]
```

### Mutations & Cache Invalidation

**Always invalidate related queries after mutations:**

```typescript
const createExpense = useMutation({
  mutationFn: (input) => expenseService.createExpense(input),
  onSuccess: (expense) => {
    // Invalidate all related queries
    queryClient.invalidateQueries({
      queryKey: queryKeys.expenses.all(expense.createdBy),
    });
    if (expense.groupId) {
      queryClient.invalidateQueries({
        queryKey: queryKeys.groups.balances(expense.groupId),
      });
    }
  },
});
```

### Currency Handling

**Multi-currency support is built-in.** Key patterns:

```typescript
// Get user's currency preferences
const { displayCurrency, conversionMode } = useCurrencyPreferences();

// Convert expenses to display currency
// Always pass conversionMode override for percentage calculations when mode is 'off'
const { conversions, isConverting } = useConvertedExpenses({ 
  expenses,
  conversionMode: conversionMode === 'smart' ? 'smart' : 'simple', // Force conversion for percentages
});

// Use converted amount (only when mode is not 'off')
const displayAmount = conversionMode !== 'off' && conversion?.converted 
  ? conversion.converted.amount 
  : expense.amount;

// Currency service for direct conversions
await currencyService.fetchCurrentRate('USD', 'ILS');     // Current rate
await currencyService.fetchHistoricalRate('USD', 'ILS', date);  // Historical
```

**Conversion modes:**
- `off` (Original) - Show original currencies, but still calculate percentages using current rates
- `simple` (Current Rate) - Convert all to display currency using today's rate
- `smart` (Historical Rate) - Convert using rate from expense date (ECB data via Frankfurter API)

**Important:** Percentage calculations ALWAYS convert to display currency for accuracy, even when displaying original currencies. This ensures category breakdowns show meaningful percentages when expenses are in multiple currencies.

### Forms with Zod

```typescript
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const schema = z.object({
  description: z.string().min(1, 'Required'),
  amount: z.number().positive('Must be positive'),
});

type FormData = z.infer<typeof schema>;

const form = useForm<FormData>({
  resolver: zodResolver(schema),
  defaultValues: { description: '', amount: 0 },
});
```

### Controlled Component Pattern (for complex sub-forms)

For complex child components that manage their own state (like `SplitConfig`):

```typescript
// Parent component
const [childOpen, setChildOpen] = useState(false);
const [childData, setChildData] = useState<ChildData>();

<ChildComponent
  open={childOpen}
  onOpenChange={setChildOpen}
  initialData={childData}    // Pass current state when opening
  onSave={setChildData}       // Update parent state on save
/>

// Child component initializes internal state from props when opened
useEffect(() => {
  if (open) {
    setInternalState(initializeFromProps(initialData, otherProps));
  }
}, [open, initialData, otherProps]);
```

This pattern avoids race conditions and ref complexity.

## POC Limitations (Do NOT Over-Engineer)

The current POC intentionally has these limitations:

1. **No real auth** - Uses mock user selector
2. **No charts** - Basic summaries only

**Don't add complexity beyond current scope unless explicitly requested.**

## Common Tasks

### Adding a New Feature

1. Add types in `src/lib/types/`
2. Add repository methods in `src/lib/repositories/`
3. Add service logic in `src/lib/services/`
4. Add query hooks in `src/hooks/queries/`
5. Add UI components in `src/components/`

### Adding shadcn Component

```bash
npx shadcn@latest add [component-name]
```

### Database Changes

1. Update `supabase/schema.sql`
2. Run SQL in Supabase dashboard
3. Update TypeScript types
4. Update repository/service

## Code Quality

- Use TypeScript strictly (no `any`)
- Format with Prettier
- Follow existing patterns in codebase
- Keep components focused and small
- Prefer composition over inheritance
- Use semantic HTML elements

## Testing Approach

Test manually using:
1. Switch between mock users via header dropdown
2. Test personal expense flow
3. Test group expense flow
4. Verify balance calculations

## Error Handling

```typescript
// In services
async getExpense(id: string): Promise<Expense | null> {
  try {
    return await this.repository.findById(id);
  } catch (error) {
    console.error('Failed to get expense:', error);
    throw error; // Let UI handle
  }
}

// In components
const { error } = useQuery(...);
if (error) {
  toast.error('Failed to load data');
}
```

## Styling Notes

- Use Tailwind CSS v4 with CSS variables
- Colors defined in `src/app/globals.css`
- Dark mode supported via `.dark` class (managed by `next-themes`)
- Mobile-first responsive design
- Use `safe-area-inset-*` for notched devices

## üåó Dark Theme Support (REQUIRED)

**All components MUST support both light and dark themes.** The app uses `next-themes` for theme management with system preference detection.

### Theme Architecture

- **ThemeProvider**: Wraps the app in `src/providers/index.tsx`
- **CSS Variables**: All colors defined as CSS variables in `src/app/globals.css`
- **Theme Modes**: Light, Dark, and System (auto-detect from OS)
- **Settings**: Theme toggle available in Settings sheet (gear icon in header)

### Semantic Color Tokens

Use these semantic tokens instead of raw Tailwind colors:

| Token | Use For | Light | Dark |
|-------|---------|-------|------|
| `bg-background` | Page backgrounds | Light gray | Dark blue-gray |
| `bg-card` | Card backgrounds | White | Slightly lighter dark |
| `text-foreground` | Primary text | Dark | Light |
| `text-muted-foreground` | Secondary text | Gray | Muted light |
| `bg-primary` | Primary actions | Purple | Lighter purple |
| `text-primary` | Primary accent text | Purple | Lighter purple |
| `bg-destructive` | Delete/error backgrounds | Red | Lighter red |
| `text-destructive` | Error text | Red | Lighter red |
| `bg-success` | Success backgrounds | Green | Lighter green |
| `text-success` | Positive values (balances) | Green | Lighter green |
| `bg-warning` | Warning backgrounds | Amber | Lighter amber |
| `text-warning-foreground` | Warning text | Dark amber | Light amber |
| `border-border` | Default borders | Light gray | Dark gray |

### Color Patterns

```typescript
// ‚úÖ CORRECT - Use semantic tokens
<div className="bg-card text-card-foreground border-border">
<span className="text-success">+$50.00</span>  // Positive balance
<span className="text-destructive">-$30.00</span>  // Negative balance
<div className="bg-warning/10 text-warning-foreground">  // Warning state

// ‚ùå WRONG - Hardcoded colors break in dark mode
<div className="bg-white text-gray-900 border-gray-200">
<span className="text-green-600">+$50.00</span>
<span className="text-red-600">-$30.00</span>
<div className="bg-amber-100 text-amber-800">
```

### Dynamic Colors with Opacity

When you need opacity variations of semantic colors:

```typescript
// ‚úÖ Use with opacity modifier
<div className="bg-primary/10">  // 10% primary background
<div className="bg-success/10 text-success">  // Success state
<div className="bg-destructive/10 border-destructive/30">

// For inline styles with category colors, use fallback patterns:
<div 
  className="bg-muted"
  style={category?.color ? { backgroundColor: `${category.color}20` } : undefined}
>
```

### Avoiding Hardcoded Colors

When using inline styles (e.g., for dynamic category colors), ALWAYS provide a theme-aware fallback:

```typescript
// ‚úÖ CORRECT - className fallback for missing colors
<Icon
  className="text-muted-foreground"
  style={expense.category?.color ? { color: expense.category.color } : undefined}
/>

// ‚ùå WRONG - Hardcoded hex fallback
<Icon style={{ color: expense.category?.color || '#64748b' }} />
```

### Dark Mode Checklist for New Components

Before submitting any new component:

1. ‚òê Uses semantic color tokens (`bg-card`, `text-foreground`, etc.)
2. ‚òê No hardcoded hex colors (`#ffffff`, `#f1f5f9`, etc.)
3. ‚òê No raw Tailwind colors for semantic meaning (`text-green-600`, `text-red-600`)
4. ‚òê Balance/status colors use `text-success`/`text-destructive`
5. ‚òê Warning states use `bg-warning/10 text-warning-foreground`
6. ‚òê Inline styles have className fallbacks
7. ‚òê Tested in BOTH light and dark modes

### Theme-Aware Patterns by Use Case

| Use Case | Pattern |
|----------|---------|
| Positive balance | `text-success` |
| Negative balance | `text-destructive` |
| Validation success | `bg-success/10 text-success` |
| Validation warning | `bg-warning/10 text-warning-foreground` |
| Error message | `text-destructive` |
| Secondary text | `text-muted-foreground` |
| Card container | `bg-card border-border` |
| Hover state | `hover:bg-accent` |
| Selected state | `border-primary bg-primary/5` |

## üåç Localization & RTL Support (REQUIRED)

**All UI text MUST be localized.** The app supports English, Hebrew (RTL), and Spanish.

### Adding Localized Text

1. **NEVER hardcode user-facing strings** in components
2. **Always use `useTranslations` hook** from `next-intl`
3. **Add translations to ALL locale files**: `src/locales/{en,he,es}.json`

```typescript
import { useTranslations } from 'next-intl';

export function MyComponent() {
  const t = useTranslations('myNamespace');
  const tCommon = useTranslations('common');
  
  return (
    <div>
      <h1>{t('title')}</h1>
      <button>{tCommon('save')}</button>
    </div>
  );
}
```

### Translation File Structure

Organize translations by feature/component namespace:

```json
{
  "common": { "save": "Save", "cancel": "Cancel", "you": "You" },
  "expenses": { "title": "All Expenses", "addExpense": "Add Expense" },
  "expenseForm": { "amount": "Amount", "description": "Description" },
  "split": { "paidBy": "Paid by", "splitEqually": "split equally" }
}
```

### RTL-Aware CSS

**Use logical properties instead of physical directions:**

| ‚ùå Don't Use | ‚úÖ Use Instead | Description |
|-------------|---------------|-------------|
| `ml-*`, `mr-*` | `ms-*`, `me-*` | Margin start/end |
| `pl-*`, `pr-*` | `ps-*`, `pe-*` | Padding start/end |
| `left-*`, `right-*` | `start-*`, `end-*` | Positioning |
| `text-left`, `text-right` | `text-start`, `text-end` | Text alignment |
| `rounded-l-*`, `rounded-r-*` | `rounded-s-*`, `rounded-e-*` | Border radius |
| `border-l-*`, `border-r-*` | `border-s-*`, `border-e-*` | Borders |

```typescript
// ‚úÖ RTL-aware
<div className="ps-4 me-2 text-start rounded-e-lg">

// ‚ùå Will break in RTL
<div className="pl-4 mr-2 text-left rounded-r-lg">
```

### RTL Icon Handling

Use `DirectionalIcon` component for icons that should flip in RTL:

```typescript
import { DirectionalIcon } from '@/components/common/rtl-icon';

<DirectionalIcon icon="chevron-right" className="h-4 w-4" />
```

For avatar stacks, add `rtl:space-x-reverse`:

```typescript
<div className="flex -space-x-2 rtl:space-x-reverse">
  {avatars}
</div>
```

### Checklist for New Components

Before submitting any new component or feature:

1. ‚òê All user-facing text uses `useTranslations`
2. ‚òê Translations added to `en.json`, `he.json`, and `es.json`
3. ‚òê No `ml-*`/`mr-*`/`pl-*`/`pr-*` (use `ms-*`/`me-*`/`ps-*`/`pe-*`)
4. ‚òê No `text-left`/`text-right` (use `text-start`/`text-end`)
5. ‚òê No `left-*`/`right-*` positioning (use `start-*`/`end-*`)
6. ‚òê Directional icons use `DirectionalIcon` or `rtl-flip` class
7. ‚òê Tested in both LTR (English) and RTL (Hebrew) modes

### Quick Reference - Locale Files

| Namespace | Use For |
|-----------|---------|
| `common` | Shared buttons, labels (Save, Cancel, You, etc.) |
| `expenses` | Expense list page, general expense messages |
| `expenseForm` | Add/Edit expense modal |
| `split` | Split configuration (payments, splits) |
| `groups` | Groups list page |
| `groupForm` | Create/Edit group modal |
| `memberPicker` | Member selection UI |
| `categories` | Category names |
| `currency` | Currency settings |
| `language` | Language settings |
| `settings` | Settings sheet (theme, appearance) |
| `datePicker` | Date picker placeholders |

## Environment Variables

Required in `.env.local`:
```
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
```

## Quick Reference

| Task | Location |
|------|----------|
| Add page | `src/app/[route]/page.tsx` |
| Add component | `src/components/[category]/` |
| Add query hook | `src/hooks/queries/` |
| Add service method | `src/lib/services/` |
| Add repository method | `src/lib/repositories/` |
| Add type | `src/lib/types/` |
| Add currency | `src/lib/constants/currencies.ts` |
| Currency conversion | `src/lib/services/currency.service.ts` |
| Currency preferences hook | `src/hooks/queries/use-currency-preferences.ts` |
| **Add translations** | `src/locales/{en,he,es}.json` |
| **RTL icon component** | `src/components/common/rtl-icon.tsx` |
| **Locale provider** | `src/providers/locale-provider.tsx` |
| **Theme provider** | `src/providers/index.tsx` (next-themes) |
| **Settings sheet** | `src/components/layout/settings-sheet.tsx` |
| **Color tokens** | `src/app/globals.css` (:root and .dark) |
| DB migrations | `supabase/migrations/` |
| Run dev server | `pnpm dev` (port 3333) |
| Build | `pnpm build` |

